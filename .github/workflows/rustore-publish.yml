name: Publish APK to RuStore

on:
  push:
    branches:
      - main
    paths:
      - 'release/app-release.apk'

jobs:
  publish_to_rustore:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ git
    
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
    
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
    
      - name: Verify APK file exists
        id: check_apk
        run: |
          APK_FILE="release/app-release.apk"
          if [ ! -f "$APK_FILE" ]; then
            echo "âŒ APK file not found: $APK_FILE"
            exit 1
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°
          APK_SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
          if [ "$APK_SIZE" -eq 0 ]; then
            echo "âŒ APK file is empty: $APK_FILE"
            exit 1
          fi
          
          # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ APK Ð² RuStore: 5GB
          MAX_SIZE=$((5 * 1024 * 1024 * 1024))
          if [ "$APK_SIZE" -gt "$MAX_SIZE" ]; then
            echo "âŒ APK file is too large: $APK_SIZE bytes (max: 5GB)"
            exit 1
          fi
          
          # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "âœ… APK file found: $APK_FILE"
          echo "ðŸ“¦ APK size: ${APK_SIZE_MB} MB (${APK_SIZE} bytes)"
          echo "apk_size=${APK_SIZE}" >> $GITHUB_OUTPUT
    
      - name: Publish to RuStore
        env:
          RUSTORE_PRIVATE_KEY: ${{ secrets.RUSTORE_PRIVATE_KEY }}
          RUSTORE_PACKAGE_NAME: ${{ secrets.RUSTORE_PACKAGE_NAME }}
          RUSTORE_KEY_ID: ${{ secrets.RUSTORE_KEY_ID }}
        run: |
          python publish_rustore.py --apk-file release/app-release.apk
